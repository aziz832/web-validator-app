<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Email Validator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
            color: #1f2937;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #5B5FED;
            font-size: 24px;
            margin-bottom: 5px;
        }
        p.subtitle {
            color: #6b7280;
            margin-bottom: 20px;
        }
        textarea, button, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: Consolas, monospace;
        }
        button {
            background-color: #5B5FED;
            color: white;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #4344c9;
        }
        .level-options {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .level-options label {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #374151;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #e5e7eb;
            text-align: left;
            font-size: 14px;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
        }

        /* Status Colors */
        .status { font-weight: bold; }
        .status.valid { color: #22c55e; }
        .status.invalid { color: #ef4444; }
        .status.risky { color: #f59e0b; }
        .status.unknown { color: #888; }
        .stats-box {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 12px;
            color: #6b7280;
        }
        #results-section {
            display: none;
        }
        .risk-low { color: #22c55e; }
        .risk-medium { color: #f59e0b; }
        .risk-high { color: #ef4444; }
        .filter-btn-group {
            display: flex;
            gap: 5px;
        }
        .filter-btn {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background-color: #f8f9fa;
            color: #495057;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .filter-btn.active {
            background-color: #5B5FED;
            color: white;
            border-color: #5B5FED;
        }
        .filter-btn:hover:not(.active) {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“§ Web Email Validator</h1>
        <p class="subtitle">Validate single or bulk email addresses on your browser.</p>

        <!-- Input Section -->
        <h2 style="font-size: 18px; margin-bottom: 10px;">Enter Email Addresses</h2>
        <textarea id="email-input" placeholder="Enter emails (one per line, or separated by commas/semicolons) Example: john@gmail.com"></textarea>


        <!-- Validation Level -->
        <input type="hidden" name="level" value="full">
        
        <div style="display: flex; gap: 10px;">
            <button id="validate-btn" onclick="startValidation()" style="flex-grow: 1;">âœ“ Validate Emails</button>
            <button id="clear-btn" onclick="clearForm()" style="width: auto; background-color: #6b7280;">Clear</button>
        </div>
        <div id="status-message" style="color: #ef4444; margin-top: 10px;"></div>

        <!-- Results Section -->
        <section id="results-section">
            <h2 style="font-size: 18px; margin-top: 30px; margin-bottom: 15px;">Validation Results</h2>
            <div class="stats-box" id="stats-panel"></div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <!-- Filter Controls -->
                <div class="filter-btn-group">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="valid">Valid</button>
                    <button class="filter-btn" data-filter="invalid">Invalid</button>
                    <button class="filter-btn" data-filter="risky">Risky</button>
                    <button class="filter-btn" data-filter="unknown">Unknown</button>
                </div>

                <!-- Export Button -->
                <button id="export-btn" onclick="exportToCsv()" style="width: auto;">Export to CSV</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 3%;">
                            <input type="checkbox" id="select-all-rows" onclick="toggleAllRows(this.checked)">
                        </th>
                        <th style="width: 5%;">#</th>
                        <th style="width: 22%;">Email</th>
                        <th style="width: 15%;">Quality</th>
                        <th style="width: 15%;">Result</th>
                        <th style="width: 15%;">Subresult</th>
                        <th style="width: 15%;">Is_From_Free_Email_Provider</th>
                    </tr>
                </thead>
                <tbody id="results-tbody">
                </tbody>
            </table>
        </section>


    </div>

    <script>
        const emailInput = document.getElementById('email-input');
        const validateBtn = document.getElementById('validate-btn');
        const resultsTbody = document.getElementById('results-tbody');
        const statsPanel = document.getElementById('stats-panel');
        const resultsSection = document.getElementById('results-section');
        const statusMessage = document.getElementById('status-message');
        const filterBtnGroup = document.querySelector('.filter-btn-group');
        let lastValidationData = null; // Store results for filtering and export

        function getSelectedLevel() {
            return 'full';
        }

        function clearForm() {
            emailInput.value = '';
            statusMessage.textContent = '';
            resultsSection.style.display = 'none';
            resultsTbody.innerHTML = '';
            lastValidationData = null;
            document.getElementById('select-all-rows').checked = false;
        }

        function toggleAllRows(isChecked) {
            const checkboxes = resultsTbody.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                // Only toggle if row is currently visible
                if (checkbox.closest('tr').style.display !== 'none') {
                    checkbox.checked = isChecked;
                }
            });
        }

        function toggleValidationState(isLoading) {
            emailInput.disabled = isLoading;
            document.getElementById('clear-btn').disabled = isLoading;
            validateBtn.disabled = isLoading;
            if (isLoading) {
                validateBtn.textContent = 'Validating... (This may take time for Full Check)';
            } else {
                validateBtn.textContent = 'âœ“ Validate Emails';
            }
        }
        
        function exportToCsv() {
            if (!lastValidationData) {
                alert('Please run a validation first.');
                return;
            }

            const dataToExport = [];
            const allRows = resultsTbody.querySelectorAll('tr');

            // Iterate through the DOM rows to find checked, visible rows
            allRows.forEach((rowElement, index) => {
                const checkbox = rowElement.querySelector('.row-checkbox');
                
                // Ensure the row belongs to the currently displayed/filtered data 
                // AND the checkbox is checked.
                if (checkbox && checkbox.checked && rowElement.style.display !== 'none') {
                    // map the index back to the stored data
                    dataToExport.push(lastValidationData.results[index]);
                }
            });

            if (dataToExport.length === 0) {
                alert("No rows selected for export or all current rows are filtered out.");
                return;
            }

            let csv = 'Status,Risk Score,Email,Message,Valid Syntax,Valid Domain,Deliverable,Is Disposable,Is Role-Based,Is Catch-All\n'; 

            dataToExport.forEach(item => {
                const row = [
                    item.status,
                    item.risk_score,
                    `"${item.email.replace(/"/g, '""')}"`, // Handle quotes in email
                    `"${item.message.replace(/"/g, '""')}"`, // Handle quotes in message
                    item.valid_syntax,
                    item.valid_domain,
                    item.deliverable === null ? '' : item.deliverable,
                    item.is_disposable,
                    item.is_role_based,
                    item.is_catch_all === null ? '' : (item.is_catch_all ? 'TRUE' : 'FALSE')
                ].join(',');
                csv += row + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
                link.setAttribute('download', 'email_validation_results.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                document.getElementById('select-all-rows').checked = false; // Reset select all
            }

        function mapStatusToQuality(status) {
            return status === 'valid' ? 'good' : 'risky';
        }

        function mapToResult(result) {
            if (result.is_catch_all === true) return 'catch_all';
            if (result.status === 'valid') return 'ok';
            if (result.status === 'invalid') return 'invalid';
            return 'ok'; // Default for risky/unknown for simplified display
        }
        
        function filterResults() {
            const activeFilters = [...filterBtnGroup.querySelectorAll('.active')].map(btn => btn.dataset.filter);
            const rows = resultsTbody.querySelectorAll('tr');

            if (activeFilters.includes('all') || activeFilters.length === 0) {
                rows.forEach(row => row.style.display = '');
                return;
            }

            rows.forEach(row => {
                const statusClass = [...row.classList].find(c => c.startsWith('status-row-')).replace('status-row-', '');
                if (activeFilters.includes(statusClass)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function updateStats(stats) {
            statsPanel.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value" style="color: #6b7280;">${stats.total}</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #22c55e;">${stats.valid}</div>
                    <div class="stat-label">Valid</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #ef4444;">${stats.invalid}</div>
                    <div class="stat-label">Invalid</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #f59e0b;">${stats.risky}</div>
                    <div class="stat-label">Risky</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #888;">${stats.unknown}</div>
                    <div class="stat-label">Unknown</div>
                </div>
            `;
        }
        
        function mapStatusToQuality(status) {
            return status === 'valid' ? 'good' : 'risky';
        }

        function mapToResult(result) {
            if (result.is_catch_all === true) return 'catch_all';
            if (result.status === 'valid') return 'ok';
            if (result.status === 'invalid') return 'invalid';
            return 'ok'; // Default for risky/unknown for simplified display
        }
        
        function displayResults(data) {
            lastValidationData = data;
            resultsTbody.innerHTML = '';
            resultsSection.style.display = 'block';
            updateStats(data.stats);

            data.results.forEach((result, index) => {
                const row = resultsTbody.insertRow();
                row.classList.add(`status-row-${result.status}`); 
                
                // Checkbox column
                const checkboxCell = row.insertCell();
                checkboxCell.innerHTML = `<input type="checkbox" class="row-checkbox" checked>`;

                // 1. Row Number (#)
                row.insertCell().textContent = index + 1;
                
                // 2. Email
                row.insertCell().textContent = result.email;
                
                // 3. Quality (email_quality)
                const qualityCell = row.insertCell();
                qualityCell.textContent = mapStatusToQuality(result.status);
                
                // 4. Result (email_result)
                row.insertCell().textContent = mapToResult(result);

                // 5. Subresult (Using main message for simplicity/mapping)
                row.insertCell().textContent = result.valid_syntax ? 'ok' : 'invalid';
                
                // 6. Is_From_Free_Email_Provider
                row.insertCell().textContent = result.is_free_provider ? 'true' : 'false';
            });
            
            filterResults();

            // Set Select All initially checked since all rows are checked by default
            document.getElementById('select-all-rows').checked = true;
        }


        filterBtnGroup.addEventListener('click', (e) => {
            const clickedBtn = e.target;
            if (!clickedBtn.classList.contains('filter-btn')) return;

            const isAllBtn = clickedBtn.dataset.filter === 'all';
            
            if (isAllBtn) {
                // If 'All' is clicked, it becomes the only active button
                if (!clickedBtn.classList.contains('active')) {
                    filterBtnGroup.querySelectorAll('.active').forEach(btn => btn.classList.remove('active'));
                    clickedBtn.classList.add('active');
                }
            } else {
                // Toggle active state for other buttons
                clickedBtn.classList.toggle('active');
                // Deactivate 'All' if any other button is active
                filterBtnGroup.querySelector('[data-filter="all"]').classList.remove('active');
            }

            // If no filters are selected, activate 'All'
            if (filterBtnGroup.querySelectorAll('.active').length === 0) {
                filterBtnGroup.querySelector('[data-filter="all"]').classList.add('active');
            }
            
            filterResults();
        });

        async function startValidation() {
            const emails = emailInput.value;
            const level = getSelectedLevel();
            
            if (!emails.trim()) {
                statusMessage.textContent = 'Please enter email addresses.';
                resultsSection.style.display = 'none';
                return;
            }
            
            // Hide previous results immediately when starting a new validation
            resultsSection.style.display = 'none';

            toggleValidationState(true);
            statusMessage.textContent = '';
            resultsTbody.innerHTML = '';


            try {
                const response = await fetch('/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emails, level })
                });

                const data = await response.json();

                if (!response.ok) {
                    statusMessage.textContent = data.error || 'An unknown error occurred on the server.';
                    resultsSection.style.display = 'none';
                    return;
                }

                displayResults(data);

            } catch (error) {
                console.error('Validation failed:', error);
                statusMessage.textContent = 'Failed to connect to the validation server.';
                resultsSection.style.display = 'none';
            } finally {
                toggleValidationState(false);
            }
        }
    </script>
</body>
</html>
